name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]

jobs:
  # 1. Security Scan
  security-scan:
    name: Security Scan (TruffleHog)
    runs-on: ubuntu-latest # Standard Linux runner is sufficient for most web/docker projects
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for TruffleHog to scan history

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: ${{ github.head_ref }}
          extra_args: --debug --only-verified

  # 2. Frontend Check (Lint & Build)
  frontend-check:
    name: Frontend Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check for lint scripts
        id: check-scripts
        run: |
          if npm run | grep -q "lint"; then
            echo "has_lint=true" >> $GITHUB_OUTPUT
          else
            echo "has_lint=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Lint
        if: steps.check-scripts.outputs.has_lint == 'true'
        run: npm run lint

      - name: Run Build
        run: npm run build
        # Note: This builds for production. If you rely on specific VITE_ env vars for domains, 
        # consider adding a step to create a .env file here or use repository secrets.

  # 3. Backend Check (Python Lint & Type Check)
  backend-check:
    name: Backend Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install ruff mypy

      - name: Run Ruff (Linting)
        run: ruff check .

      - name: Run Mypy (Type Checking)
        run: mypy . --ignore-missing-imports

  # 4. AI Service Check (Python Lint)
  ai-service-check:
    name: AI Service Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ai_service_detect
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install ruff

      - name: Run Ruff (Linting)
        run: ruff check .
