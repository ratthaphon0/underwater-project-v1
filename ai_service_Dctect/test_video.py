import cv2
from ultralytics import YOLO
import os

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Path ‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ ‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢) ---
# ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà
CURRENT_DIR = os.path.dirname(os.path.abspath(__file__))

# ‡∏ä‡∏µ‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà Model (‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Git ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
MODEL_PATH = os.path.join(CURRENT_DIR, 'models', 'best.pt')

# ‡∏ä‡∏µ‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà Video (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
# ‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ fish_video.mp4, fish_video_2.mp4 ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡∏™‡∏±‡∏Å‡∏≠‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö
VIDEO_PATH = os.path.join(CURRENT_DIR, 'fish_video.mp4') 

# ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
OUTPUT_DIR = os.path.join(CURRENT_DIR, 'runs', 'detect', 'video_result')

def main():
    print(f"üìÇ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: {CURRENT_DIR}")

    # --- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå ---
    if not os.path.exists(MODEL_PATH):
        print(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà: {MODEL_PATH}")
        print("üí° ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏° git pull ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡πÑ‡∏ü‡∏•‡πå best.pt ‡πÉ‡∏™‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå models ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö")
        return

    if not os.path.exists(VIDEO_PATH):
        print(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏µ‡πà: {VIDEO_PATH}")
        print("üí° ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÑ‡∏´‡∏°")
        return

    # --- ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• ---
    print(f"üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•: {os.path.basename(MODEL_PATH)}")
    try:
        model = YOLO(MODEL_PATH)
    except Exception as e:
        print(f"‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: {e}")
        return

    # --- ‡πÄ‡∏õ‡∏¥‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ---
    print(f"üé• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠: {os.path.basename(VIDEO_PATH)}")
    cap = cv2.VideoCapture(VIDEO_PATH)

    if not cap.isOpened():
        print("‚ùå ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
        return

    # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    cv2.namedWindow("Tilapia Detection", cv2.WINDOW_NORMAL)
    cv2.resizeWindow("Tilapia Detection", 800, 600) # ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏≠‡∏ö

    print("üü¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô... ‡∏Å‡∏î 'q' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å")

    while True:
        ret, frame = cap.read()
        if not ret:
            print("üé¨ ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß")
            break

        # ‡πÉ‡∏´‡πâ AI ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
        # conf=0.5 ‡∏Ñ‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à 50% ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏à‡∏±‡∏ö
        results = model.predict(frame, conf=0.5, verbose=False)

        # ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏•‡∏á‡∏ö‡∏ô‡∏†‡∏≤‡∏û
        annotated_frame = results[0].plot()

        # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        cv2.imshow("Tilapia Detection", annotated_frame)

        # ‡∏Å‡∏î q ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î
        if cv2.waitKey(1) & 0xFF == ord('q'):
            break

    cap.release()
    cv2.destroyAllWindows()
    print("‚úÖ ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô")

if __name__ == "__main__":
    main()